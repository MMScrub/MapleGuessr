<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MapleGuessr</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Menu -->
<div id="menu" style="display:flex; flex-direction:column; align-items:center;">
  <h1 id="title">MapleGuessr</h1>
  <button id="play-items">Play Items</button>
  <button id="howto-toggle">How to Play +</button>
  <div id="howto-content" style="display:none;">
    <p><b>Goal:</b> Guess the hidden MapleLegends item of the day.</p>
    <p><b>Colors:</b><br>
      Green = Exact match<br>
      Yellow = Partial match<br>
      Red = No match</p>
    <p><b>Equip Level:</b> âœ“ = exact, â†‘ higher, â†“ lower, â€” non-equipable.</p>
    <p><b>Source badges:</b> [Mob] [PQ] [Gachapon] [Quest]</p>
  </div>
</div>

<!-- Game -->
<div id="game" style="display:none;">
  <div id="controls">
    <button id="reset-btn">Reset Game (Dev)</button>
    <button id="random-btn">Random Answer (Dev)</button>
    <button id="daily-btn">Daily Mode (Dev)</button>
    <button id="next-btn">Next Answer (Dev)</button>
    <button id="reveal-btn">Reveal Answer (Dev)</button>
    <span id="reveal"></span>
  </div>

  <h2 id="mode"></h2>
  <p id="guess-counter"></p>
  <input id="guess-input" type="text" placeholder="Enter your guess...">
  <button id="submit-btn">Submit</button>
  <ul id="suggestions"></ul>

  <table id="guess-table">
    <thead>
      <tr>
        <th>Item</th>
        <th>Equip Level</th>
        <th>Stackable</th>
        <th>Class Type</th>
        <th>Tradable</th>
        <th>Dropped By / Source</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p id="result"></p>
</div>

<!-- Main Game Logic -->
<script type="module">
import { pool as POOL } from './data/pool.js';

/* Load pool instantly from JS */
async function loadPoolData() {
  return POOL;
}

/* ================== Dev Buttons ================== */
document.getElementById("reset-btn").addEventListener("click", () => {
  localStorage.clear();
  location.reload();
});
document.getElementById("random-btn").addEventListener("click", () => {
  const idx = Math.floor(Math.random() * (window.__POOL__?.length || 1));
  localStorage.setItem("dev_force_index", String(idx));
  localStorage.setItem("guesses_items", JSON.stringify({ date: new Date().toDateString(), guesses: [] }));
  location.reload();
});
document.getElementById("daily-btn").addEventListener("click", () => {
  localStorage.removeItem("dev_force_index");
  localStorage.setItem("guesses_items", JSON.stringify({ date: new Date().toDateString(), guesses: [] }));
  location.reload();
});
document.getElementById("next-btn").addEventListener("click", () => {
  const len = window.__POOL__?.length || 1;
  const current = parseInt(localStorage.getItem("dev_force_index") ?? "-1", 10);
  const next = isNaN(current) ? 0 : (current + 1) % len;
  localStorage.setItem("dev_force_index", String(next));
  localStorage.setItem("guesses_items", JSON.stringify({ date: new Date().toDateString(), guesses: [] }));
  location.reload();
});
document.getElementById("reveal-btn").addEventListener("click", () => {
  const ans = getAnswerFromPool(window.__POOL__ || []);
  document.getElementById("reveal").textContent = `Answer (Dev): ${ans?.name || 'â€”'}`;
});

/* ================== Menu Controls ================== */
document.getElementById("play-items").addEventListener("click", async () => {
  document.getElementById("menu").style.display = "none";
  document.getElementById("game").style.display = "block";
  const pool = await loadPoolData();
  window.__POOL__ = pool;
  window.__SUGGEST_INDEX__ = pool;
  startGame(pool);
});
document.getElementById("title").addEventListener("click", () => {
  document.getElementById("menu").style.display = "flex";
  document.getElementById("game").style.display = "none";
});
document.getElementById("howto-toggle").addEventListener("click", () => {
  const content = document.getElementById("howto-content");
  const toggle = document.getElementById("howto-toggle");
  if (content.style.display === "block") {
    content.style.display = "none";
    toggle.textContent = "How to Play +";
  } else {
    content.style.display = "block";
    toggle.textContent = "How to Play â€“";
  }
});

/* ================== Game Helpers ================== */
function getAnswerFromPool(pool) {
  const forced = localStorage.getItem("dev_force_index");
  if (forced !== null) {
    const idx = Math.max(0, Math.min(pool.length - 1, parseInt(forced, 10) || 0));
    return pool[idx];
  }
  const todayIndex = new Date().getDate() % pool.length;
  return pool[todayIndex];
}
function isRandomMode() {
  return localStorage.getItem("dev_force_index") !== null;
}

/* Badge helpers */
function getDropType(src) {
  const s = (src || "").toLowerCase();
  if (s.includes("gachapon")) return "gachapon";
  if (s.includes("pq")) return "pq";
  if (s.includes("quest")) return "quest";
  return "mob";
}
function formatOneSource(src) {
  const t = getDropType(src);
  const cls = t === "pq" ? "pq" : t === "gachapon" ? "gach" : t === "quest" ? "quest" : "mob";
  const label = t === "pq" ? "[PQ]" : t === "gachapon" ? "[Gachapon]" : t === "quest" ? "[Quest]" : "[Mob]";
  return `<span class="badge ${cls}">${label}</span>${src}`;
}
function formatSourceWithBadge(src) {
  const list = Array.isArray(src) ? src : (src ? [src] : []);
  if (list.length === 0) return "";
  const first = formatOneSource(list[0]);
  const moreCount = list.length - 1;
  const more = moreCount > 0 ? ` <span style="opacity:.85;">(+${moreCount} more)</span>` : "";
  const title = list.join(", ");
  return `<span title="${title}">${first}${more}</span>`;
}
function dropColor(guessDrop, answerDrop) {
  const gList = Array.isArray(guessDrop) ? guessDrop : (guessDrop ? [guessDrop] : []);
  const aList = Array.isArray(answerDrop) ? answerDrop : (answerDrop ? [answerDrop] : []);
  for (const g of gList) for (const a of aList) {
    if ((g || "") === (a || "")) return "green";
  }
  for (const g of gList) for (const a of aList) {
    if (getDropType(g) === getDropType(a)) return "yellow";
  }
  return "red";
}
function highlightName(guessName, answerName) {
  const aSet = new Set(answerName.split(/\s+/).map(s => s.toLowerCase()));
  return guessName.split(/\s+/).map(w => aSet.has(w.toLowerCase()) ? `<b>${w}</b>` : w).join(' ');
}

/* Level helpers */
function bothNull(aMin, aMax, bMin, bMax) {
  return aMin == null && aMax == null && bMin == null && bMax == null;
}
function anyNull(aMin, aMax, bMin, bMax) {
  const aNull = (aMin == null || aMax == null);
  const bNull = (bMin == null || bMax == null);
  return aNull || bNull;
}
function rangesOverlap(gMin, gMax, aMin, aMax) {
  return !(gMax < aMin || aMax < gMin);
}
function rangeGap(gMin, gMax, aMin, aMax) {
  if (rangesOverlap(gMin, gMax, aMin, aMax)) return 0;
  if (gMax < aMin) return aMin - gMax;
  return gMin - aMax;
}
function levelColor(gMin, gMax, aMin, aMax) {
  if (bothNull(gMin, gMax, aMin, aMax)) return 'green';
  if (anyNull(gMin, gMax, aMin, aMax)) return 'red';
  if (rangesOverlap(gMin, gMax, aMin, aMax)) return 'green';
  return rangeGap(gMin, gMax, aMin, aMax) <= 5 ? 'yellow' : 'red';
}
function levelDisplay(gMin, gMax, aMin, aMax) {
  if (gMin == null || gMax == null) return "â€”";
  const text = (gMin === gMax) ? `${gMax}` : `${gMin}â€“${gMax}`;
  if (aMin == null || aMax == null) return text;
  if (rangesOverlap(gMin, gMax, aMin, aMax)) return `${text} âœ“`;
  if (gMax < aMin) return `${text} â†‘`;
  if (gMin > aMax) return `${text} â†“`;
  return text;
}

/* ================== Game Logic ================== */
function startGame(pool) {
  const modeEl = document.getElementById("mode");
  modeEl.innerHTML = isRandomMode()
    ? `Mode: <span class="random">Random (Dev)</span>`
    : `Mode: <span class="daily">Daily</span>`;
  const answer = getAnswerFromPool(pool);
  const today = new Date().toDateString();
  let guessesData = JSON.parse(localStorage.getItem("guesses_items")) || { date: today, guesses: [] };
  if (guessesData.date !== today && !isRandomMode()) {
    guessesData = { date: today, guesses: [] };
    localStorage.setItem("guesses_items", JSON.stringify(guessesData));
  }
  const guessInput = document.getElementById("guess-input");
  const submitBtn = document.getElementById("submit-btn");
  const tableBody = document.querySelector("#guess-table tbody");
  const result = document.getElementById("result");
  const suggestionBox = document.getElementById("suggestions");
  const counterEl = document.getElementById("guess-counter");
  tableBody.innerHTML = "";
  updateCounter();
  guessInput.focus();
  (guessesData.guesses || []).forEach(g => addGuessToTable(g));
  function updateCounter() {
    counterEl.textContent = `Guess #${(guessesData.guesses?.length || 0) + 1}`;
  }
  function addGuessToTable(item) {
    const row = document.createElement("tr");
    if (item.name === answer.name) row.classList.add("answer-row");
    row.innerHTML = `
      <td class="${item.name === answer.name ? 'green' : 'red'} name-partial">${highlightName(item.name, answer.name)}</td>
      <td class="${levelColor(item.minLevel, item.maxLevel, answer.minLevel, answer.maxLevel)}">${levelDisplay(item.minLevel, item.maxLevel, answer.minLevel, answer.maxLevel)}</td>
      <td class="${item.stackable === answer.stackable ? 'green' : 'red'}">${item.stackable ? 'Yes' : 'No'}</td>
      <td class="${item.classType === answer.classType ? 'green' : 'red'}">${item.classType}</td>
      <td class="${item.tradable === answer.tradable ? 'green' : 'red'}">${item.tradable ? 'Yes' : 'No'}</td>
      <td class="${dropColor(item.droppedBy, answer.droppedBy)}">${formatSourceWithBadge(item.droppedBy)}</td>
    `;
    tableBody.appendChild(row);
  }
  guessInput.addEventListener("input", () => {
    const val = guessInput.value.trim().toLowerCase();
    suggestionBox.innerHTML = "";
    if (!val) return;
    const src = window.__SUGGEST_INDEX__ || pool;
    const matches = src.filter(e => e.name.toLowerCase().includes(val));
    matches.slice(0, 8).forEach(match => {
      const li = document.createElement("li");
      li.textContent = match.name;
      li.onclick = () => {
        guessInput.value = match.name;
        suggestionBox.innerHTML = "";
      };
      suggestionBox.appendChild(li);
    });
  });
  submitBtn.addEventListener("click", () => {
    const userGuess = guessInput.value.trim().toLowerCase();
    if (!userGuess) return;
    if ((guessesData.guesses || []).find(g => g.name.toLowerCase() === userGuess)) {
      alert("Already guessed that!");
      guessInput.focus();
      return;
    }
    const item = pool.find(i => i.name.toLowerCase() === userGuess);
    if (!item) {
      alert("Item not found in pool.");
      guessInput.focus();
      return;
    }
    guessesData.guesses.push(item);
    localStorage.setItem("guesses_items", JSON.stringify(guessesData));
    addGuessToTable(item);
    if (item.name.toLowerCase() === answer.name.toLowerCase()) {
      result.textContent = `ðŸŽ‰ Correct! You got it in ${guessesData.guesses.length} guesses.`;
      result.style.color = "#6dff6d";
    } else {
      result.textContent = "Not quite, try again.";
      result.style.color = "#ff7a7a";
    }
    updateCounter();
    guessInput.value = "";
    suggestionBox.innerHTML = "";
    guessInput.focus();
  });
}
</script>
</body>
</html>
